package com.electricityBillingSystem.services;

import java.sql.SQLIntegrityConstraintViolationException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import javax.persistence.PersistenceException;

import com.electricityBillingSystem.beans.User;
import com.electricityBillingSystem.dao.AdminDAO;
import com.electricityBillingSystem.dao.IAdminDAO;
import com.electricityBillingSystem.exceptions.DuplicateEntryException;

import static com.electricityBillingSystem.util.ReadUserData.getIntegerValue;
import static com.electricityBillingSystem.util.ReadUserData.getLongValue;
import static com.electricityBillingSystem.util.ReadUserData.getStringValue;
import static com.electricityBillingSystem.util.ReadUserData.getDateValue;

import static com.electricityBillingSystem.util.InputValidatorUtil.validateName;
import static com.electricityBillingSystem.util.InputValidatorUtil.validateDob;
import static com.electricityBillingSystem.util.InputValidatorUtil.validatePhoneNumber;
import static com.electricityBillingSystem.util.InputValidatorUtil.validateEmail;

import static com.electricityBillingSystem.util.ElectricityBillingSystemUtil.closeApplication;
import static com.electricityBillingSystem.util.ElectricityBillingSystemUtil.adminLogout;

import org.apache.commons.lang3.StringUtils;

public class AdminServices implements IAdminServices {

	@Override
	public void adminHomePage(User user) throws Exception {

		System.out.println("________________________________________");
		System.out.println("********** Admin Home Page *************");
		System.out.println("________________________________________");
		System.out.println("1. Generate Bills");
		System.out.println("2. View Bills");
		System.out.println("3. Add New Connection");
		System.out.println("4. View Customers");
		System.out.println("5. View Your profile");
		System.out.println("6. Logout");
		System.out.println("7. Close Application");
		System.out.println("________________________________________");
		System.out.println("Enter your choice:");
		int option = getIntegerValue("Option: ");

		switch (option) {
		case 1:
			break;
		case 2:
			break;
		case 3:
			addNewCustomer();
			break;
		case 4:
			displayAllUsers(user);
			break;
		case 5:
			displayAdminInformation(user);
			break;
		case 6:
			adminLogout(user);
			break;
		case 7:
			closeApplication();
			break;
		default:
			System.out.println("Please choose a correct option..\n");
			adminHomePage(user);
			break;

		}

	}

	@Override
	public void displayAdminInformation(User user) throws Exception {
		System.out.println("________________________________________");
		System.out.println("************** Your Profile ************");
		System.out.println("________________________________________\n");
		System.out.println("Admin ID: " + user.getId());
		System.out.println("Full Name: " + user.getName());
		
		String pattern = "dd MMM yyyy";
		SimpleDateFormat simpleDateFormat = new SimpleDateFormat(pattern);
		String date = simpleDateFormat.format(user.getDob());

		System.out.println("Date of Birth: " + date);
		System.out.println("Mobile Number: " + user.getPhoneNumber());
		System.out.println("Email: " + user.getEmail());
		System.out.println("Address: " + user.getAddress());
		System.out.println("\n****************************************");
		System.out.println("1. Edit Profile");
		System.out.println("2. Back to Home");
		System.out.println("3. Logout");
		System.out.println("4. Close Application");
		System.out.println("________________________________________");
		System.out.println("Enter your choice:");
		int option = getIntegerValue("Option: ");

		switch (option) {
		case 1:
			break;
		case 2:
			adminHomePage(user);
			break;
		case 3:
			adminLogout(user);
			break;
		case 4:
			closeApplication();
			break;
		default:
			System.out.println("Please choose a correct option..\n");
			displayAdminInformation(user);
			break;
		}
	}

	@Override
	public void addNewCustomer() throws Exception {
		
		System.out.println("________________________________________");
		System.out.println("***** New Connection Registration ******");
		System.out.println("________________________________________\n");
		
		
		String name = validateName(getStringValue("Full Name*: "));
		String email = validateEmail(getStringValue("Email*: "));
		long phoneNumber = validatePhoneNumber(getLongValue("Contact Number*: "));
		String phone = "" + phoneNumber;
		String address = getStringValue("Address: ");
		Date dob = validateDob(getDateValue("Date of Birth* (like 20 JAN 2000): "));
		int meterId = getIntegerValue("Meter Id: ");
		System.out.println("Enter 1 for ADMIN\nEnter 2 for USER");
		int roleId = getIntegerValue("Role: ");
		
		User user = new User();
		
		user.setName(name);
		user.setEmail(email);
		user.setPhoneNumber(phone);
		user.setAddress(address);
		user.setDob(dob);
		user.setMeterId(meterId);
		user.setRoleId(roleId);
		user.setStatus(1);
		
		IAdminDAO adminDao = new AdminDAO();
		try {
			adminDao.registerNewCustomer(user);
			System.out.println("Registration Successfull...");
		} catch (SQLIntegrityConstraintViolationException | DuplicateEntryException | PersistenceException e) {
			throw new DuplicateEntryException();
		}
		adminHomePage(user);
	}

	public void displayAllUsers(User user) throws Exception {
		System.out.println("________________________________________");
		System.out.println("************** EBS Customers ***********");
		System.out.println("________________________________________\n");
		
		IAdminDAO adminDao = new AdminDAO();
		List<Object[]> customerList = adminDao.getAllCustomers();
		
		String idFormat = "| %1$-13s | ";
		String nameFormat = "| %2$-20s|";
		String emailFormat = "| %2$-20s|";
        String dateFormat = " %2$tb %2$td, %2$tY  | ";
        String format = idFormat.concat(nameFormat).concat(emailFormat);
        String line = new String(new char[100]).replace('\0', '-');
        
        System.out.println(line);
        System.out.printf("|%s|%s|%s|%n",
                StringUtils.center("Id", 13),
                StringUtils.center("Name", 20),
                StringUtils.center("Phone Number", 20));
        System.out.println(line);

		
		for(Object[] customer : customerList) {
			
			System.out.println(line);
			System.out.printf(format, customer[0], customer[1], customer[2]);
//			System.out.println("Id: " + customer[1]);
//			System.out.println("Name: " + customer[2]);
//			System.out.println("Email: " + customer[3]);
		}
		
		System.out.println("\n****************************************");
		System.out.println("1. Back to Home");
		System.out.println("2. Logout");
		System.out.println("3. Close Application");
		System.out.println("________________________________________");
		System.out.println("Enter your choice:");
		int option = getIntegerValue("Option: ");

		switch (option) {
		case 1:
			adminHomePage(user);
			break;
		case 2:
			adminLogout(user);
			break;
		case 3:
			closeApplication();
			break;
		default:
			System.out.println("Please choose a correct option..\n");
			displayAllUsers(user);
			break;
		}
		
		
	}

}
